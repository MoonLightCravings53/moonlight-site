<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlight Vault | Owner</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { background: #fce4ec; font-family: sans-serif; padding: 20px; color: #4a148c; }
        h1 { color: #b76e79; text-align: center; letter-spacing: 2px; }
        
        .admin-controls { text-align: center; margin-bottom: 30px; }
        .btn-clear { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        #orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; max-width: 1400px; margin: auto; }
        
        .order-card { background: white; border-radius: 20px; padding: 20px; border-top: 6px solid #b76e79; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; }
        
        .delete-x { position: absolute; top: 10px; right: 15px; color: #ccc; cursor: pointer; font-size: 1.5rem; font-weight: bold; }
        .delete-x:hover { color: #e74c3c; }

        .label { display: block; font-size: 0.7rem; color: #b76e79; font-weight: bold; text-transform: uppercase; margin-top: 8px; }
        
        /* CHAT SECTION */
        .chat-container { margin-top: 15px; background: #fff9fa; border-radius: 12px; border: 1px solid #f3d0d7; padding: 10px; }
        .chat-display { height: 120px; overflow-y: auto; font-size: 0.85rem; margin-bottom: 8px; display: flex; flex-direction: column; gap: 4px; }
        .msg { padding: 4px 8px; border-radius: 8px; max-width: 85%; }
        .msg.Admin { background: #b76e79; color: white; align-self: flex-end; }
        .msg.User { background: #eee; color: #333; align-self: flex-start; }
        
        .chat-input-row { display: flex; gap: 5px; }
        .chat-input-row input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        .btn-send { background: #4a148c; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; }

        .btn-call { display: block; width: 100%; padding: 12px; background: #2ecc71; color: white; text-align: center; text-decoration: none; border-radius: 12px; font-weight: bold; margin-top: 15px; box-sizing: border-box; }
    </style>
</head>
<body>

    <h1>MOONLIGHT VAULT üåô</h1>
    
    <div class="admin-controls">
        <button class="btn-clear" onclick="clearAllOrders()">üóëÔ∏è CLEAR ALL DEBUG ORDERS</button>
    </div>

    <div id="orders-grid">Connecting to Moonlight Cloud...</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBLvz14iffabRCLRc3FuDvqhCvN5qs3a84",
            authDomain: "moonlight-cravings.firebaseapp.com",
            projectId: "moonlight-cravings",
            storageBucket: "moonlight-cravings.firebasestorage.app",
            messagingSenderId: "222974574228",
            appId: "1:222974574228:web:47bed645deedf5788bbe81"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // LISTEN TO ORDERS
        db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = ''; // Clear display

            snap.forEach(doc => {
                const o = doc.data();
                const orderId = doc.id;
                
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <span class="delete-x" onclick="deleteOrder('${orderId}')">√ó</span>
                    <div style="font-weight:bold; font-size:1.1rem; color:#b76e79; padding-right:20px;">${o.item}</div>
                    <span class="label">Price</span><div>‚Çπ${o.price}</div>
                    <span class="label">Customer</span><div>${o.name}</div>
                    <span class="label">üìç Address</span><div style="font-size:0.85rem;">${o.address}</div>
                    
                    <div class="chat-container">
                        <div class="chat-display" id="chat-box-${orderId}"></div>
                        <div class="chat-input-row">
                            <input type="text" id="input-${orderId}" placeholder="Reply to customer...">
                            <button class="btn-send" onclick="sendReply('${orderId}')">‚û§</button>
                        </div>
                    </div>

                    <a href="tel:${o.phone}" class="btn-call">üìû CALL +91 ${o.phone}</a>
                `;
                grid.appendChild(card);
                loadMessages(orderId);
            });
        });

        // LOAD LIVE CHAT MESSAGES
        function loadMessages(id) {
            db.collection("orders").doc(id).collection("chats").orderBy("timestamp")
              .onSnapshot(snap => {
                  const box = document.getElementById(`chat-box-${id}`);
                  if(box) {
                      box.innerHTML = snap.docs.map(d => `
                        <div class="msg ${d.data().sender}">${d.data().text}</div>
                      `).join('');
                      box.scrollTop = box.scrollHeight;
                  }
              });
        }

        // SEND REPLY TO CUSTOMER
        async function sendReply(id) {
            const input = document.getElementById(`input-${id}`);
            if(!input.value) return;
            await db.collection("orders").doc(id).collection("chats").add({
                text: input.value,
                sender: "Admin",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }

        // DELETE SINGLE ORDER
        async function deleteOrder(id) {
            if(confirm("Delete this order forever?")) {
                await db.collection("orders").doc(id).delete();
            }
        }

        // CLEAR ALL ORDERS (DEBUG TOOL)
        async function clearAllOrders() {
            if(confirm("‚ö†Ô∏è This will wipe ALL orders in your vault. Are you sure?")) {
                const snap = await db.collection("orders").get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("Vault Cleared!");
            }
        }
    </script>
</body>
</html>
