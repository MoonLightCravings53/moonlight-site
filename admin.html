<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlight Vault | Owner Command Center</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --plum: #4a148c; --rose: #b76e79; --light: #fff1f5; --green: #25D366; --gold: #ffd700; }
        body { background: var(--light); font-family: 'Segoe UI', sans-serif; padding: 20px; color: var(--plum); margin: 0; }
        
        .header-area { text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 25px; border-radius: 20px; border: 2px solid var(--rose); background: white; cursor: pointer; font-weight: bold; color: var(--rose); }
        .tab-btn.active { background: var(--rose); color: white; }

        #orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 25px; max-width: 1400px; margin: auto; }
        
        .order-card { background: white; border-radius: 20px; padding: 20px; border-top: 6px solid var(--rose); box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; }
        .status-badge { align-self: flex-start; padding: 4px 10px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; }
        .status-new { background: #ffebee; color: #c62828; }
        .status-confirmed { background: #e8f5e9; color: #2e7d32; }

        .points-box { background: var(--light); border: 2px dashed gold; padding: 10px; border-radius: 15px; margin-top: 15px; text-align: center; }
        .points-box input { width: 60px; padding: 5px; border-radius: 5px; border: 1px solid #ddd; text-align: center; }

        .btn-confirm { background: var(--plum); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-gift { background: gold; color: var(--plum); border: none; padding: 8px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-left: 5px; }
        
        /* Chat styles from your original admin */
        .chat-container { margin-top: 15px; background: #fff9fa; border-radius: 12px; border: 1px solid #f3d0d7; padding: 10px; }
        .chat-display { height: 100px; overflow-y: auto; font-size: 0.85rem; display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #f3d0d7; }
        .msg.Admin { background: var(--rose); color: white; align-self: flex-end; padding: 5px; border-radius: 5px; }
        .msg.User { background: #eee; align-self: flex-start; padding: 5px; border-radius: 5px; }
        .btn-wa { background: var(--green); color: white; text-decoration: none; padding: 10px; border-radius: 10px; text-align: center; display: block; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-area">
        <h1>MOONLIGHT VAULT ðŸŒ™</h1>
        <div class="tabs">
            <button class="tab-btn active" id="tab-new" onclick="switchTab('new')">NEW PLACED ORDERS</button>
            <button class="tab-btn" id="tab-done" onclick="switchTab('confirmed')">CONFIRMED ORDERS</button>
        </div>
    </div>

    <div id="orders-grid">Loading...</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBLvz14iffabRCLRc3FuDvqhCvN5qs3a84", authDomain: "moonlight-cravings.firebaseapp.com", projectId: "moonlight-cravings", storageBucket: "moonlight-cravings.firebasestorage.app", messagingSenderId: "222974574228", appId: "1:222974574228:web:47bed645deedf5788bbe81" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentTab = 'new';

        function switchTab(t) {
            currentTab = t;
            document.getElementById('tab-new').classList.toggle('active', t === 'new');
            document.getElementById('tab-done').classList.toggle('active', t === 'confirmed');
            loadOrders();
        }

        function loadOrders() {
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
                const grid = document.getElementById('orders-grid');
                grid.innerHTML = '';
                snap.forEach(doc => {
                    const o = doc.data();
                    const isConfirmed = o.status === 'confirmed';
                    
                    if ((currentTab === 'new' && !isConfirmed) || (currentTab === 'confirmed' && isConfirmed)) {
                        const card = document.createElement('div');
                        card.className = 'order-card';
                        card.innerHTML = `
                            <div class="status-badge ${isConfirmed ? 'status-confirmed' : 'status-new'}">${isConfirmed ? 'CONFIRMED' : 'PENDING'}</div>
                            <div style="font-weight:bold;">${o.item} - â‚¹${o.price}</div>
                            <div style="font-size:0.8rem;">Customer: ${o.name} (${o.phone})</div>
                            
                            <div class="chat-container">
                                <div class="chat-display" id="chat-${doc.id}"></div>
                                <div style="display:flex; gap:5px; margin-top:5px;">
                                    <input type="text" id="in-${doc.id}" style="flex:1;" placeholder="Reply...">
                                    <button onclick="sendReply('${doc.id}')">âž¤</button>
                                </div>
                            </div>

                            ${!isConfirmed ? 
                                `<button class="btn-confirm" onclick="confirmOrder('${doc.id}')">âœ… CONFIRM ORDER</button>` : 
                                `<div class="points-box">
                                    <span>Gift MoonLight Points:</span><br>
                                    <input type="number" id="pts-${doc.id}" value="100">
                                    <button class="btn-gift" onclick="giftPoints('${doc.id}', '${o.customerIP}')">GIFT POINTS</button>
                                </div>`
                            }
                            <a href="https://wa.me/${o.phone.replace(/\D/g,'')}" target="_blank" class="btn-wa">WhatsApp Customer</a>
                        `;
                        grid.appendChild(card);
                        loadChat(doc.id);
                    }
                });
            });
        }

        async function confirmOrder(id) {
            if(confirm("Are you sure this order is confirmed?")) {
                await db.collection("orders").doc(id).update({ status: 'confirmed' });
                alert("Order Confirmed! Moved to Confirmed tab.");
            }
        }

        async function giftPoints(orderId, ip) {
            const amount = document.getElementById(`pts-${orderId}`).value;
            if(confirm(`Gift ${amount} MoonLight Points to this customer?`)) {
                await db.collection("points_pending").doc(ip).set({ amount: parseInt(amount) });
                alert("Points sent! Customer will see a claim popup next time they visit.");
            }
        }

        function loadChat(id) {
            db.collection("orders").doc(id).collection("chats").orderBy("timestamp").onSnapshot(s => {
                const box = document.getElementById(`chat-${id}`);
                if(box) box.innerHTML = s.docs.map(d => `<div class="msg ${d.data().sender}">${d.data().text}</div>`).join('');
            });
        }

        async function sendReply(id) {
            const val = document.getElementById(`in-${id}`).value;
            await db.collection("orders").doc(id).collection("chats").add({ text: val, sender: "Admin", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById(`in-${id}`).value = "";
        }

        window.onload = loadOrders;
    </script>
</body>
</html>
